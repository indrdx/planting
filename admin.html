<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zone Maanpur Planting Table</title>
  <style>
    body { background: #eef2f7; font-family: 'Segoe UI', Arial, sans-serif; margin:0;}
    .container { max-width:1100px; margin:30px auto; background:#fff; border-radius:14px; box-shadow:0 5px 22px #0002; border:1px solid #dde; padding:18px 10px 18px 10px;}
    h1 {text-align:center; color:#0581a6; margin-bottom:22px;}
    .form-grid {display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px 16px; margin-bottom: 10px;}
    .form-grid > div { min-width: 160px;}
    label {font-weight:525; margin-top:4px; color:#26717d; font-size:1em;}
    input, select {
      width:100%; padding:8px; margin-top:4px; border-radius:4px; border:1.2px solid #b4d8e3;
      font-size:1em; background:#f7fbfc;
    }
    input:focus,select:focus { border:1.2px solid #52cdef; background:#f4fcff}
    .actions {margin-top:10px; margin-bottom:4px;}
    button { padding:9px 16px; border-radius:5px; font-size:1.06em; border:none; margin-top:10px; cursor:pointer; color:#fff; background:#009879; transition:.16s;}
    button:disabled {background:#aaa;}
    .add-btn {background:#388edd;}
    .final-btn {background:#319c4a; margin-left:9px;}
    .reset-btn {background:#fd4545; margin-left:10px;}
    .edit-btn {background:#d86d16; font-size:0.96em; padding:5px 11px;}
    .preview-table {margin-top:13px;margin-bottom:20px;}
    .responsive-table {overflow-x:auto; margin-top:30px;}
    table {width:100%; border-collapse:collapse; min-width:900px; background:#f9fdff; margin-top:14px;}
    th, td {text-align:center; padding:8px 5px; border:1px solid #cbe5fc; font-size:1em;}
    th {background:#0a899d; color:#fff;}
    tr:nth-child(even){background-color:#f3fafd;}
    .total-row { background:#e9f9df; font-weight:600;}
    .final-actions {margin-bottom:18px; text-align:center;}
    .print-btn { background:#395bdb; margin-right:10px;}
    .img-btn {background:#fba600; margin-right:10px;}
    .wa-btn {background:#25d366;}
    @media (max-width:980px){.form-grid{grid-template-columns:repeat(2,1fr);}}
    @media (max-width:700px){
      .container{max-width:99%; padding:4px;}
      th,td{font-size:0.92em;padding:6px 3px;}
      table{min-width:630px;}
      .form-grid{grid-template-columns:1fr;}
    }
    @media (max-width:500px){
      th,td{font-size:0.87em; padding:4px 2px;} h1{font-size:1.11em;} table{min-width:580px;}
      .final-actions button {font-size:0.95em; padding:9px;}
    }
    .img-capture .final-actions {display:none !important;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Zone Maanpur - Planting Data (All Circles)</h1>
    <form id="multiCircleForm" autocomplete="off" onsubmit="event.preventDefault();addCircleData();">
      <div class="form-grid">
        <div>
          <label>Circle
            <select id="circle" required>
              <option value="">Choose</option>
              <option value="BIZARKHATA">BIZARKHATA</option>
              <option value="NANKAR RANI">NANKAR RANI</option>
              <option value="BHOOBRA">BHOOBRA</option>
              <option value="RAHMATGANJ">RAHMATGANJ</option>
              <option value="LOHRA">LOHRA</option>
            </select>
          </label>
        </div>
        <div>
          <label>Target <input type="number" id="target" readonly /></label>
        </div>
        <div>
          <label>Ondate Planting Area (ha)
            <input type="number" id="ondateArea" min="0" step="0.01" required />
          </label>
        </div>
        <div>
          <label>Ondate Planting Plot
            <input type="number" id="ondatePlot" min="0" required />
          </label>
        </div>
        <div>
          <label>Todate Planting Area (ha)
            <input type="number" id="todateArea" min="0" step="0.01" required />
          </label>
        </div>
        <div>
          <label>Todate Planting Plot
            <input type="number" id="todatePlot" min="0" required />
          </label>
        </div>
      </div>
      <div class="actions">
        <button class="add-btn" type="submit" id="addBtn">Add Circle</button>
        <button class="final-btn" type="button" onclick="showTable()" id="finalBtn" disabled>Final Submit & View</button>
        <button class="reset-btn" type="button" onclick="resetAll()">Reset All</button>
      </div>
    </form>
    <div class="preview-table" id="previewTable"></div>
    <div class="responsive-table" id="tableView" style="display:none;">
      <div class="final-actions" id="finalActions">
        <button class="print-btn" onclick="printTable()">Print</button>
        <button class="img-btn" onclick="downloadTableImg()">Download Image</button>
        <button class="wa-btn" onclick="shareWhatsApp()">Share WhatsApp</button>
      </div>
      <div id="zoneDataWrap"></div>
    </div>
  </div>
<!-- html2canvas CDN -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
var circleMaster = {
    "BIZARKHATA": 110,
    "NANKAR RANI": 130,
    "BHOOBRA": 230,
    "RAHMATGANJ": 220,
    "LOHRA": 310
};
var allCircleNames = Object.keys(circleMaster);
var list = [];
var editIndex = null;

document.getElementById('circle').addEventListener('change', function(){
  let v = this.value;
  document.getElementById('target').value = (v && circleMaster[v]) ? circleMaster[v] : "";
});

window.addCircleData = function() {
  let c = document.getElementById('circle').value,
      t = Number(document.getElementById('target').value),
      oa = Number(document.getElementById('ondateArea').value),
      op = Number(document.getElementById('ondatePlot').value),
      ta = Number(document.getElementById('todateArea').value),
      tp = Number(document.getElementById('todatePlot').value);
  if(!c || !t || isNaN(oa) || isNaN(op) || isNaN(ta) || isNaN(tp)){
    alert("Please fill all required fields!");
    return;
  }
  let percent = (t ? ((ta/t)*100).toFixed(2) : "0.00");
  if(editIndex !== null){
    list[editIndex] = {circle: c, target: t, ondateArea: oa, ondatePlot: op, todateArea: ta, todatePlot: tp, percent: percent};
    editIndex = null;
  } else {
    if(list.some(x=>x.circle===c)){
      alert("This circle data has already been added!");
      return;
    }
    list.push({circle: c, target: t, ondateArea: oa, ondatePlot: op, todateArea: ta, todatePlot: tp, percent: percent});
  }
  renderPreview();
  document.querySelector(`#circle option[value="${c}"]`).disabled = true;
  document.getElementById('circle').value = "";
  document.getElementById('target').value = "";
  document.getElementById('ondateArea').value = "";
  document.getElementById('ondatePlot').value = "";
  document.getElementById('todateArea').value = "";
  document.getElementById('todatePlot').value = "";
  document.getElementById('addBtn').textContent = "Add Circle";
  if(list.length === allCircleNames.length){
    document.getElementById('finalBtn').disabled = false;
    document.getElementById('addBtn').disabled = true;
  }
};

function renderPreview() {
  if(list.length === 0){document.getElementById('previewTable').innerHTML = ""; return;}
  let table = `<table><tr>
    <th>Circle</th>
    <th>Target</th>
    <th>Ondate Area (ha)</th>
    <th>Ondate Plot</th>
    <th>Todate Area (ha)</th>
    <th>Todate Plot</th>
    <th>Percentage Planting</th>
    <th>संशोधन (Edit)</th>
  </tr>`;
  list.forEach((row,i)=>{
    table += `<tr>
      <td>${row.circle}</td>
      <td>${row.target}</td>
      <td>${row.ondateArea}</td>
      <td>${row.ondatePlot}</td>
      <td>${row.todateArea}</td>
      <td>${row.todatePlot}</td>
      <td>${row.percent} %</td>
      <td><button class="edit-btn" onclick="editRow(${i})">Edit</button></td>
    </tr>`;
  });
  table += `</table>`;
  document.getElementById('previewTable').innerHTML = table;
}

window.editRow = function(index){
  let row = list[index];
  document.getElementById('circle').value = row.circle;
  document.getElementById('target').value = row.target;
  document.getElementById('ondateArea').value = row.ondateArea;
  document.getElementById('ondatePlot').value = row.ondatePlot;
  document.getElementById('todateArea').value = row.todateArea;
  document.getElementById('todatePlot').value = row.todatePlot;
  document.getElementById('addBtn').textContent = "Update";
  editIndex = index;
  document.getElementById('addBtn').disabled = false;
};

// Show & Render Table
window.showTable = function() {
  let totalArea = 0, totalPlot = 0, totalTArea = 0, totalTPlot = 0, totalTarget = 0;
  let table = `<table id="zoneTable"><tr>
    <th>Circle</th>
    <th>Target</th>
    <th>Ondate Area (ha)</th>
    <th>Ondate Plot</th>
    <th>Todate Area (ha)</th>
    <th>Todate Plot</th>
    <th>Percentage Planting</th>
  </tr>`;
  list.forEach(row=>{
    table += `<tr>
      <td>${row.circle}</td>
      <td>${row.target}</td>
      <td>${row.ondateArea}</td>
      <td>${row.ondatePlot}</td>
      <td>${row.todateArea}</td>
      <td>${row.todatePlot}</td>
      <td>${row.percent} %</td>
    </tr>`;
    totalArea += row.ondateArea;
    totalPlot += row.ondatePlot;
    totalTArea += row.todateArea;
    totalTPlot += row.todatePlot;
    totalTarget += row.target;
  });
  let totalPercent = totalTarget===0 ? "0.00" : ((totalTArea / totalTarget)*100).toFixed(2);
  table += `<tr class="total-row">
    <td>Total Zone</td>
    <td>${totalTarget}</td>
    <td>${totalArea.toFixed(2)}</td>
    <td>${totalPlot}</td>
    <td>${totalTArea.toFixed(2)}</td>
    <td>${totalTPlot}</td>
    <td>${totalPercent} %</td>
  </tr>`;
  table += `</table>`;
  document.getElementById('zoneDataWrap').innerHTML = table;
  document.getElementById('tableView').style.display = "block";
  document.getElementById('multiCircleForm').style.display = "none";
  document.getElementById('previewTable').style.display = "none";
};

function printTable(){
  let printContents = `<h2 style='text-align:center;color:#0581a6;'>Zone Maanpur - All Circle Data</h2>` +
    document.getElementById('zoneDataWrap').innerHTML;
  let originalContent = document.body.innerHTML;
  document.body.innerHTML = printContents;
  window.print();
  document.body.innerHTML = originalContent;
  window.location.reload();
}

// WhatsApp share
function shareWhatsApp(){
  let rows = list.map(row =>
    `Circle: ${row.circle} | Target: ${row.target} | Ondate Area: ${row.ondateArea} ha | Ondate Plot: ${row.ondatePlot} | Todate Area: ${row.todateArea} ha | Todate Plot: ${row.todatePlot} | %: ${row.percent}`
  );
  let totalArea = list.reduce((s, r) => s + r.ondateArea, 0);
  let totalPlot = list.reduce((s, r) => s + r.ondatePlot, 0);
  let totalTArea = list.reduce((s, r) => s + r.todateArea, 0);
  let totalTPlot = list.reduce((s, r) => s + r.todatePlot, 0);
  let totalTarget = list.reduce((s, r) => s + r.target, 0);
  let totalPercent = totalTarget===0 ? "0.00" : ((totalTArea / totalTarget)*100).toFixed(2);
  let msg =
    "Zone Maanpur - All Circle Planting Data\n\n" +
    rows.join("\n") +
    `\nTotal Zone: Target=${totalTarget}, Ondate Area=${totalArea.toFixed(2)} ha, Ondate Plot=${totalPlot}, Todate Area=${totalTArea.toFixed(2)} ha, Todate Plot=${totalTPlot} | %=${totalPercent}`;
  let url = "https://wa.me/?text=" + encodeURIComponent(msg);
  window.open(url, "_blank");
}

// Download as image
function downloadTableImg(){
  const wrap = document.getElementById('tableView');
  wrap.classList.add('img-capture');
  html2canvas(wrap, {
    backgroundColor: '#eef2f7',
    scale: 2
  }).then(canvas=>{
    wrap.classList.remove('img-capture');
    let link = document.createElement('a');
    link.download = 'zone_maanpur_report.png';
    link.href = canvas.toDataURL();
    link.click();
  }).catch(error => {
    wrap.classList.remove('img-capture');
    alert('Image download issue');
  });
}

window.resetAll = function() {
  list = [];
  editIndex = null;
  document.getElementById('tableView').style.display = "none";
  document.getElementById('multiCircleForm').style.display = "block";
  document.getElementById('finalBtn').disabled = true;
  document.getElementById('addBtn').disabled = false;
  document.getElementById('addBtn').textContent = "Add Circle";
  document.getElementById('previewTable').innerHTML = "";
  document.getElementById('previewTable').style.display = "block";
  [...document.querySelectorAll('#circle option')].forEach(o=>o.disabled=false);
};
</script>
</body>
</html>
